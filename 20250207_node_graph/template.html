<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>PyVis Network with Modern Physics Controls</title>
    <style type="text/css">
      /* 기본 스타일 */
      body { margin: 0; padding: 0; overflow: hidden; }

      /* 메인 컨테이너: 좌측 그래프 / 우측 상세 영역 */
      #container {
        display: flex;
        height: 100vh;
        width: 100%;
      }

      /* 좌측 그래프 영역 */
      #graphContainer {
        width: 70%;
        min-width: 100px;
        height: 100%;
        background: #222222;
      }

      /* 좌우 divider */
      #dragbar {
        width: 5px;
        background-color: #aaa;
        cursor: ew-resize;
      }

      /* 우측 상세 영역 (내부 요소 배치를 위해 position: relative) */
      #details {
        width: 30%;
        min-width: 100px;
        height: 100%;
        position: relative;
        background: #f0f0f0;
      }

      /* XML 코드 영역: 물리 제어 패널이 가리지 않도록 높이 및 스크롤 활성 */
      #xmlContainer {
        overflow-y: auto;
        padding: 10px;
        color: #000;
        box-sizing: border-box;
        height: calc(100% - 525px); /* 물리 컨트롤 영역(550px) + 수평 드래그바(5px) */
      }
      #xmlContainer h3 { margin-top: 0; }
      pre {
        white-space: pre-wrap;
        word-wrap: break-word;
      }

      /* 수평 드래그바: XML 영역과 물리 컨트롤 영역 경계 조절 */
      #horizontalDragbar {
        position: absolute;
        left: 0;
        right: 0;
        height: 5px;
        background-color: #aaa;
        cursor: ns-resize;
        bottom: 520px; /* 물리 컨트롤 영역 높이 */
      }

      /* 물리 컨트롤 영역: 하단에 고정, 높이 550px */
      #physicsContainer {
        position: absolute;
        left: 0;
        right: 0;
        bottom: 0;
        height: 520px;
        overflow-y: auto;
        background: #ffffff;
        padding: 20px;
        box-sizing: border-box;
        border-top: 1px solid #ccc;
      }
      #physicsContainer h3 { margin-top: 0; }

      /* 슬라이더 그룹: 모던한 디자인 적용 */
      .sliderGroup {
        margin: 15px 0;
        padding: 10px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      }
      .sliderGroup label {
        display: block;
        margin-bottom: 5px;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        font-size: 14px;
        color: #333;
      }
      .sliderGroup input[type="range"] {
        -webkit-appearance: none;
        width: 100%;
        height: 5px;
        background: #ddd;
        border-radius: 5px;
        outline: none;
      }
      .sliderGroup input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 15px;
        height: 15px;
        border-radius: 50%;
        background: #007BFF;
        cursor: pointer;
        border: none;
      }
      .sliderGroup input[type="range"]::-moz-range-thumb {
        width: 15px;
        height: 15px;
        border-radius: 50%;
        background: #007BFF;
        cursor: pointer;
        border: none;
      }

      /* 선택 스위치 스타일 (크기를 작게 조정) */
      .switch {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 28px;
        vertical-align: middle;
      }
      .switch input {
        opacity: 0;
        width: 0;
        height: 0;
      }
      .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: #ccc;
        transition: .4s;
        border-radius: 34px;
      }
      .slider:before {
        position: absolute;
        content: "";
        height: 22px;
        width: 22px;
        left: 3px;
        bottom: 3px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
      }
      input:checked + .slider {
        background-color: #007BFF;
      }
      input:checked + .slider:before {
        transform: translateX(25px);
      }

      /* Reset 버튼: 토글 스위치의 푸른색(#007BFF) 적용 */
      #resetPhysicsButton {
        display: inline-block;
        padding: 8px 16px;
        font-size: 14px;
        color: #fff;
        background: #007BFF;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
    </style>
    <script type="text/javascript" src="https://unpkg.com/vis-network@9.1.2/dist/vis-network.min.js"></script>
  </head>
  <body>
    <div id="container">
      <div id="graphContainer"></div>
      <div id="dragbar"></div>
      <div id="details">
        <!-- XML 코드 출력 영역 -->
        <div id="xmlContainer">
          <h3>Node XML Code</h3>
          <pre id="xmlCode">노드를 클릭하면 XML 코드가 이곳에 표시됩니다.</pre>
        </div>
        <!-- 수평 드래그바 -->
        <div id="horizontalDragbar"></div>
        <!-- 물리 제어 패널 -->
        <div id="physicsContainer">
          <h3>Physics Controls</h3>
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
            <div style="display: flex; align-items: center;">
              <!-- 선택형 스위치 (왼쪽 정렬) -->
              <label class="switch">
                <input type="checkbox" id="physicsCheckbox" onchange="togglePhysics()" checked>
                <span class="slider"></span>
              </label>
              <span style="vertical-align: middle; font-size: 16px; margin-left: 10px;">Physics Enabled</span>
            </div>
            <div>
              <!-- Reset 버튼 (오른쪽 정렬) -->
              <button id="resetPhysicsButton" onclick="resetPhysicsParameters()">Reset</button>
            </div>
          </div>
          <div class="sliderGroup">
            <label for="gravity">Gravity: <span id="gravityValue"></span></label>
            <input type="range" id="gravity" min="-200" max="0" step="1">
          </div>
          <div class="sliderGroup">
            <label for="central_gravity">Central Gravity: <span id="centralGravityValue"></span></label>
            <input type="range" id="central_gravity" min="0" max="0.1" step="0.001">
          </div>
          <div class="sliderGroup">
            <label for="spring_length">Spring Length: <span id="springLengthValue"></span></label>
            <input type="range" id="spring_length" min="0" max="300" step="1">
          </div>
          <div class="sliderGroup">
            <label for="spring_strength">Spring Strength: <span id="springStrengthValue"></span></label>
            <input type="range" id="spring_strength" min="0" max="1" step="0.01">
          </div>
          <div class="sliderGroup">
            <label for="damping">Damping: <span id="dampingValue"></span></label>
            <input type="range" id="damping" min="0" max="1" step="0.01">
          </div>
        </div>
      </div>
    </div>

    <script type="text/javascript">
      // pyvis에서 전달받은 노드, 엣지, 옵션 데이터를 이용하여 vis.Network 객체 생성
      var nodes = new vis.DataSet({{ nodes | safe }});
      var edges = new vis.DataSet({{ edges | safe }});
      var container = document.getElementById("graphContainer");
      var data = { nodes: nodes, edges: edges };
      var options = {{ options | safe }};
      var network = new vis.Network(container, data, options);

      // XML 코드 출력 및 노드 선택 처리
      var brightMapping = {
        "cornflowerblue": "#b9c8f7",
        "#d2cb7f": "#eae5be",
        "#e76a83": "#f9b6bf",
        "#6e3741": "#f9b6bf"
      };
      var lastSelectedNodeId = null;
      function selectNode(nodeId) {
        if (lastSelectedNodeId !== null && lastSelectedNodeId !== nodeId) {
          var prevNode = nodes.get(lastSelectedNodeId);
          if (prevNode && prevNode.origColor) {
            nodes.update({ id: lastSelectedNodeId, color: prevNode.origColor });
          }
        }
        var node = nodes.get(nodeId);
        if (node && node.origColor && brightMapping[node.origColor]) {
          nodes.update({ id: nodeId, color: brightMapping[node.origColor] });
        }
        lastSelectedNodeId = nodeId;
        document.getElementById("xmlCode").innerText = node.title;
      }
      network.on("click", function(params) {
        if (params.nodes.length > 0) {
          selectNode(params.nodes[0]);
        } else {
          if (lastSelectedNodeId !== null) {
            var prevNode = nodes.get(lastSelectedNodeId);
            if (prevNode && prevNode.origColor) {
              nodes.update({ id: lastSelectedNodeId, color: prevNode.origColor });
            }
          }
          lastSelectedNodeId = null;
          document.getElementById("xmlCode").innerText = "노드를 클릭하면 XML 코드가 이곳에 표시됩니다.";
        }
      });
      network.on("dragStart", function(params) {
        if (params.nodes.length > 0) {
          selectNode(params.nodes[0]);
        }
      });

      // 좌/우 드래그: 그래프와 상세 영역 너비 조절
      var dragbar = document.getElementById("dragbar");
      var containerEl = document.getElementById("container");
      var leftSide = document.getElementById("graphContainer");
      var rightSide = document.getElementById("details");
      var dragging = false;
      dragbar.addEventListener("mousedown", function(e) {
        e.preventDefault();
        dragging = true;
      });
      document.addEventListener("mousemove", function(e) {
        if (!dragging) return;
        var containerWidth = containerEl.offsetWidth;
        var pointerRelativeX = e.clientX - containerEl.offsetLeft;
        var minLeft = 100;
        var maxLeft = containerWidth - 100 - dragbar.offsetWidth;
        if (pointerRelativeX < minLeft) pointerRelativeX = minLeft;
        if (pointerRelativeX > maxLeft) pointerRelativeX = maxLeft;
        var leftPercent = (pointerRelativeX / containerWidth) * 100;
        var rightPercent = 100 - leftPercent - (dragbar.offsetWidth / containerWidth) * 100;
        leftSide.style.width = leftPercent + "%";
        rightSide.style.width = rightPercent + "%";
      });
      document.addEventListener("mouseup", function(e) {
        dragging = false;
      });
      window.addEventListener("resize", function() {
        var containerWidth = containerEl.offsetWidth;
        var leftWidth = leftSide.offsetWidth;
        var rightWidth = rightSide.offsetWidth;
        leftSide.style.width = (leftWidth / containerWidth) * 100 + "%";
        rightSide.style.width = (rightWidth / containerWidth) * 100 + "%";
      });

      // 수평 드래그: 물리 컨트롤 영역 높이 조절
      var horizontalDragbar = document.getElementById("horizontalDragbar");
      var physicsContainer = document.getElementById("physicsContainer");
      var xmlContainer = document.getElementById("xmlContainer");
      var draggingVertical = false;
      horizontalDragbar.addEventListener("mousedown", function(e) {
        e.preventDefault();
        draggingVertical = true;
      });
      document.addEventListener("mousemove", function(e) {
        if (!draggingVertical) return;
        var detailsRect = document.getElementById("details").getBoundingClientRect();
        var newHeight = detailsRect.bottom - e.clientY;
        var minHeight = 100;
        var maxHeight = detailsRect.height - 50 - horizontalDragbar.offsetHeight;
        if (newHeight < minHeight) newHeight = minHeight;
        if (newHeight > maxHeight) newHeight = maxHeight;
        physicsContainer.style.height = newHeight + "px";
        horizontalDragbar.style.bottom = newHeight + "px";
        xmlContainer.style.height = "calc(100% - " + (newHeight + horizontalDragbar.offsetHeight) + "px)";
      });
      document.addEventListener("mouseup", function(e) {
        draggingVertical = false;
      });

      // 물리 시뮬레이션 제어 및 초기값 설정
      var physicsEnabled = (options.physics && options.physics.enabled !== undefined) ? options.physics.enabled : true;
      // 엔진의 초기 물리 파라미터 (forceAtlas2Based 사용 시)
      var initialPhysics = {
        gravity: (options.physics && options.physics.forceAtlas2Based && options.physics.forceAtlas2Based.gravitationalConstant) || -50,
        centralGravity: (options.physics && options.physics.forceAtlas2Based && options.physics.forceAtlas2Based.centralGravity) || 0.005,
        springLength: (options.physics && options.physics.forceAtlas2Based && options.physics.forceAtlas2Based.springLength) || 95,
        springStrength: (options.physics && options.physics.forceAtlas2Based && options.physics.forceAtlas2Based.springConstant) || 0.04,
        damping: (options.physics && options.physics.forceAtlas2Based && options.physics.forceAtlas2Based.damping) || 0.09
      };

      // 슬라이더 초기값을 엔진의 값으로 설정
      document.getElementById("gravity").value = initialPhysics.gravity;
      document.getElementById("gravityValue").innerText = initialPhysics.gravity;
      document.getElementById("central_gravity").value = initialPhysics.centralGravity;
      document.getElementById("centralGravityValue").innerText = initialPhysics.centralGravity;
      document.getElementById("spring_length").value = initialPhysics.springLength;
      document.getElementById("springLengthValue").innerText = initialPhysics.springLength;
      document.getElementById("spring_strength").value = initialPhysics.springStrength;
      document.getElementById("springStrengthValue").innerText = initialPhysics.springStrength;
      document.getElementById("damping").value = initialPhysics.damping;
      document.getElementById("dampingValue").innerText = initialPhysics.damping;

      function updatePhysicsParameters() {
        var newGravity = parseFloat(document.getElementById("gravity").value);
        var newCentralGravity = parseFloat(document.getElementById("central_gravity").value);
        var newSpringLength = parseFloat(document.getElementById("spring_length").value);
        var newSpringStrength = parseFloat(document.getElementById("spring_strength").value);
        var newDamping = parseFloat(document.getElementById("damping").value);
        network.setOptions({
          physics: {
            enabled: physicsEnabled,
            solver: 'forceAtlas2Based',
            forceAtlas2Based: {
              gravitationalConstant: newGravity,
              centralGravity: newCentralGravity,
              springLength: newSpringLength,
              springConstant: newSpringStrength,
              damping: newDamping
            }
          }
        });
      }

      // 토글 스위치 변경 시 물리 활성화 상태 업데이트
      function togglePhysics() {
        physicsEnabled = document.getElementById("physicsCheckbox").checked;
        updatePhysicsParameters();
      }

      function resetPhysicsParameters() {
        document.getElementById("gravity").value = initialPhysics.gravity;
        document.getElementById("gravityValue").innerText = initialPhysics.gravity;
        document.getElementById("central_gravity").value = initialPhysics.centralGravity;
        document.getElementById("centralGravityValue").innerText = initialPhysics.centralGravity;
        document.getElementById("spring_length").value = initialPhysics.springLength;
        document.getElementById("springLengthValue").innerText = initialPhysics.springLength;
        document.getElementById("spring_strength").value = initialPhysics.springStrength;
        document.getElementById("springStrengthValue").innerText = initialPhysics.springStrength;
        document.getElementById("damping").value = initialPhysics.damping;
        document.getElementById("dampingValue").innerText = initialPhysics.damping;
        updatePhysicsParameters();
      }

      // 슬라이더 이벤트 리스너
      document.getElementById("gravity").addEventListener("input", function(){
        document.getElementById("gravityValue").innerText = this.value;
        updatePhysicsParameters();
      });
      document.getElementById("central_gravity").addEventListener("input", function(){
        document.getElementById("centralGravityValue").innerText = this.value;
        updatePhysicsParameters();
      });
      document.getElementById("spring_length").addEventListener("input", function(){
        document.getElementById("springLengthValue").innerText = this.value;
        updatePhysicsParameters();
      });
      document.getElementById("spring_strength").addEventListener("input", function(){
        document.getElementById("springStrengthValue").innerText = this.value;
        updatePhysicsParameters();
      });
      document.getElementById("damping").addEventListener("input", function(){
        document.getElementById("dampingValue").innerText = this.value;
        updatePhysicsParameters();
      });

      updatePhysicsParameters();
    </script>
  </body>
</html>
